<!DOCTYPE html>

<!-- This code is modified from mbostock's example: http://bl.ocks.org/mbostock/4063530 -->

<meta charset="utf-8">
<head>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	
	<script type="text/javascript" src="js_lib/jquery.tipsy.js"></script>
  
	<script src="js_lib/colors.js"></script>
  <script src="js_lib/shared_functions.js"></script>
	<script src="js_lib/jquery-1.11.0.min.js"></script>
  
  <link href="style/reset.css" media="all" rel="stylesheet" type="text/css"/>
  <link href="style/shared.css" media="all" rel="stylesheet" type="text/css" />
  <link href="style/hierarchy.css" media="all" rel="stylesheet" type="text/css" />

  
</head>
<body>
  <div id="header"></div>
	<div id="graph"><div><p id="tooltip"></p></div></div>
	<div id="legend"></div>
  
	<div id="description"></div>


<script>

/** File and page layout setup **/

var url_obj = urlObject();

var sample_num = url_obj["parameters"]["s"];
// Default to sample 1
if  (!sample_num) {sample_num = 1; console.log("did not specify a valid sample number; default is to display sample 1");}
var file_name = "json/tree-species/S" + sample_num + "_tree_species.json";


var home_link = d3.select("#header").append("a")
  .attr("href", "http://dirtmap.org");

home_link.append("h2")
    .text("\u00AB dirtmap.org");


d3.select("#description").append("h2")
	.text("File: " + file_name);
	
  var links_par = d3.select("#description").append("p");
  
  links_par.append("a")
      .attr("href", "./CircleHierarchy.html?s="+(sample_num-1).toString())
      .text("\u00AB prev  ");
    
  links_par.append("span")
      .text(" . . . ");

  links_par.append("a")
    .attr("href", "./CircleHierarchy.html?s="+(sample_num+1).toString())
    .text("  next \u00bB");
    
    d3.select("#description").append("p")
    	.text("A hierarchical representation of the bacteria in this sample, from kingdom through species. Innermost circles represent species of bacteria and are sized to reflect the proportion of with which they are found in the sample.");


/** graph setup **/


var margin = 10,
    outerDiameter = 800,
    innerDiameter = outerDiameter - margin - margin;

var x = d3.scale.linear()
    .range([0, innerDiameter]);

var y = d3.scale.linear()
    .range([0, innerDiameter]);



var color = d3.scale.linear()
    .domain([-1, 5])
    .range([(d3.lab("#A08A7C").brighter(1)).toString(), (d3.lab("#A08A7C").darker(2)).toString()])
    .interpolate(d3.interpolateHcl);

var pack = d3.layout.pack()
    .padding(2)
    .size([innerDiameter, innerDiameter])
    .value(function(d) { return d.percent; })

var svg = d3.select("#graph").append("svg")
    .attr("width", outerDiameter)
    .attr("height", outerDiameter)
  .append("g")
    .attr("transform", "translate(" + margin + "," + margin + ")");

d3.json(file_name, function(error, root) {
  var focus = root,
      nodes = pack.nodes(root);

svg.append("g").selectAll("circle")
      .data(nodes)
    .enter().append("circle")
      .attr("class", function(d) { return d.parent ? d.children ? "node" : "node node--leaf" : "node node--root"; })
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
      .attr("r", function(d) { return d.r; })
      .style("fill", function(d) { return d.children ? color(d.depth) : null; })
      .on("click", function(d) { return zoom(focus == d ? root : d); });


  d3.select(window)
      .on("click", function() { zoom(root); });

  function zoom(d, i) {
    var focus0 = focus;
    focus = d;

    var k = innerDiameter / d.r / 2;
    x.domain([d.x - d.r, d.x + d.r]);
    y.domain([d.y - d.r, d.y + d.r]);
    d3.event.stopPropagation();

    var transition = d3.selectAll("text,circle").transition()
        .duration(d3.event.altKey ? 7500 : 750)
        .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

    transition.filter("circle")
        .attr("r", function(d) { return k * d.r; });

  }
});

d3.select(self.frameElement).style("height", outerDiameter + "px");

</script>
